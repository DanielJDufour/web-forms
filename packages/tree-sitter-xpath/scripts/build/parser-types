#!/usr/bin/env node
// @ts-check

const { spawnSync } = require('node:child_process');
const fs = require('node:fs');
const path = require('node:path');

const cwd = process.cwd();
const baseTypeGeneratorPath = path.resolve(
	__dirname,
	'../../../../node_modules/@asgerf/dts-tree-sitter/build/src/index.js'
);

const baseGeneratedTypes = spawnSync('node', [baseTypeGeneratorPath, cwd]).stdout.toString('utf-8');

const correctedTypes = baseGeneratedTypes.replaceAll(
	/((?<=\n)[ \t]*constructor\([^)]*\));[ ]*\n/g,
	'$1: this;'
);

const wrappedTypes = [
	"declare module '@odk-web-forms/tree-sitter-xpath/parser' {",
	correctedTypes,
	'}',
	'',
].join('\n');

fs.mkdirSync('./types', {
	recursive: true,
});
fs.writeFileSync('./types/tree-sitter-xpath-parser.d.ts', wrappedTypes);
